# Guia Completo: Resolvendo Erro de Deploy no EasyPanel

## ğŸ” AnÃ¡lise do Problema

### O Erro
VocÃª estÃ¡ enfrentando o erro `ERR_MODULE_NOT_FOUND: Cannot find package 'vite'` ao fazer deploy no EasyPanel via GitHub e Dockerfile.

### DiagnÃ³stico TÃ©cnico

**Problema Principal:** O Vite estÃ¡ sendo importado em tempo de execuÃ§Ã£o no ambiente de produÃ§Ã£o, mas nÃ£o estÃ¡ disponÃ­vel nas dependÃªncias de produÃ§Ã£o.

**EvidÃªncias do erro:**
- O erro aparece em `/app/dist/index.js` linha 130:49
- CÃ³digo: `'ERR_MODULE_NOT_FOUND'`
- O Node.js v20.19.4 nÃ£o consegue encontrar o pacote 'vite'

### Problemas Identificados na ConfiguraÃ§Ã£o Atual

#### 1. **Dockerfile ProblemÃ¡tico**
- Usa `npm ci --only=production` que exclui devDependencies
- O Vite precisa estar disponÃ­vel durante o build
- Build multi-estÃ¡gio nÃ£o estÃ¡ copiando dependÃªncias corretamente

#### 2. **Vite Config Complexo**
- Plugins condicionais baseados em `NODE_ENV` e `REPL_ID`
- Usa `import.meta.dirname` que pode falhar
- DependÃªncias especÃ­ficas do Replit causam problemas

#### 3. **Estrutura de Build Inconsistente**
- Dockerfile espera arquivos em `dist/`
- Vite config gera em `dist/public`
- Scripts de entrada procuram arquivos diferentes

#### 4. **Ambiente EasyPanel**
- VariÃ¡veis de ambiente nÃ£o definidas corretamente
- Build acontece em ambiente diferente do desenvolvimento
- DependÃªncias nÃ£o instaladas na ordem correta

## ğŸ› ï¸ SoluÃ§Ãµes Completas

### SoluÃ§Ã£o 1: Dockerfile Corrigido (RECOMENDADA)

Substitua seu Dockerfile atual por este:

```dockerfile
# Dockerfile otimizado para EasyPanel
FROM node:20-alpine AS base

# Instalar dependÃªncias do sistema
RUN apk add --no-cache libc6-compat

# Etapa de instalaÃ§Ã£o de dependÃªncias
FROM base AS deps
WORKDIR /app

# Copiar arquivos de dependÃªncias
COPY package.json package-lock.json* ./

# Instalar TODAS as dependÃªncias (incluindo devDependencies para o build)
RUN npm ci

# Etapa de build
FROM base AS builder
WORKDIR /app

# Copiar dependÃªncias da etapa anterior
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Definir variÃ¡veis de ambiente para o build
ENV NODE_ENV=production
ENV REPL_ID=""

# Fazer o build da aplicaÃ§Ã£o
RUN npm run build

# Etapa de produÃ§Ã£o
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV PORT=5013

# Criar usuÃ¡rio nÃ£o-root
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copiar apenas os arquivos necessÃ¡rios para produÃ§Ã£o
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package.json ./package.json

# Instalar apenas dependÃªncias de produÃ§Ã£o
RUN npm ci --only=production && npm cache clean --force

# Definir permissÃµes
RUN chown -R nextjs:nodejs /app
USER nextjs

EXPOSE 5013

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:5013/api/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) }).on('error', () => process.exit(1))" || exit 1

CMD ["node", "dist/index.js"]
```

**Principais mudanÃ§as:**
- Instala todas as dependÃªncias na etapa de build
- Define `REPL_ID=""` para desabilitar plugins problemÃ¡ticos
- Separa corretamente build e produÃ§Ã£o
- Comando final simplificado

### SoluÃ§Ã£o 2: Vite Config Simplificado

Crie um arquivo `vite.config.production.ts`:

```typescript
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import path from "path";

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "client", "src"),
      "@shared": path.resolve(__dirname, "shared"),
      "@assets": path.resolve(__dirname, "attached_assets"),
    },
  },
  root: path.resolve(__dirname, "client"),
  build: {
    outDir: path.resolve(__dirname, "dist/public"),
    emptyOutDir: true,
    rollupOptions: {
      output: {
        manualChunks: undefined,
      },
    },
  },
  define: {
    'process.env.NODE_ENV': '"production"',
  },
});
```

**E atualize seu package.json:**

```json
{
  "scripts": {
    "build": "npm run build:frontend && npm run build:backend",
    "build:frontend": "vite build --config vite.config.production.ts",
    "build:backend": "tsc",
    "start": "node dist/index.js",
    "dev": "concurrently \"npm run dev:backend\" \"npm run dev:frontend\"",
    "dev:backend": "nodemon --exec ts-node server/index.ts",
    "dev:frontend": "vite"
  },
  "dependencies": {
    "express": "^4.18.0",
    "cors": "^2.8.5"
  },
  "devDependencies": {
    "vite": "^5.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "typescript": "^5.0.0",
    "nodemon": "^3.0.0",
    "ts-node": "^10.9.0",
    "concurrently": "^8.0.0"
  }
}
```

### SoluÃ§Ã£o 3: Servidor Express Limpo (ALTERNATIVA)

Se as soluÃ§Ãµes acima nÃ£o funcionarem, use este servidor Express limpo.

Crie um arquivo `server-production.js` na raiz do projeto:

```javascript
const express = require('express');
const path = require('path');
const cors = require('cors');

const app = express();
const PORT = process.env.PORT || 5013;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, 'dist/public')));

// Health check endpoint
app.get('/api/health', (req, res) => {
  res.status(200).json({ status: 'OK', timestamp: new Date().toISOString() });
});

// API routes (ajuste conforme sua estrutura)
// app.use('/api', require('./dist/api'));

// Serve React app for all other routes
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'dist/public/index.html'));
});

app.listen(PORT, '0.0.0.0', () => {
  console.log(`ğŸš€ Server running on port ${PORT}`);
  console.log(`ğŸ” Environment: ${process.env.NODE_ENV}`);
  console.log(`ğŸ“ Serving static files from: ${path.join(__dirname, 'dist/public')}`);
});
```

**E modifique o Dockerfile para usar este servidor:**

```dockerfile
# ... (mesmo inÃ­cio do Dockerfile corrigido)

# Na etapa final, adicione:
COPY --from=builder /app/server-production.js ./server-production.js

# E mude o CMD para:
CMD ["node", "server-production.js"]
```

### SoluÃ§Ã£o 4: Script de Build Robusto

Crie um arquivo `build.sh`:

```bash
#!/bin/bash
set -e

echo "ğŸ”§ Starting build process..."

# Limpar builds anteriores
rm -rf dist/

# Build frontend
echo "ğŸ“¦ Building frontend..."
NODE_ENV=production npx vite build --config vite.config.production.ts

# Build backend
echo "ğŸ”¨ Building backend..."
npx tsc

# Copiar arquivos necessÃ¡rios
echo "ğŸ“‹ Copying production files..."
cp server-production.js dist/server.js
cp package.json dist/

echo "âœ… Build completed successfully!"
```

Torne executÃ¡vel: `chmod +x build.sh`

E atualize o package.json:
```json
{
  "scripts": {
    "build": "./build.sh",
    "start": "node dist/server.js"
  }
}
```

## âš™ï¸ ConfiguraÃ§Ã£o no EasyPanel

### VariÃ¡veis de Ambiente
Configure estas variÃ¡veis no seu projeto EasyPanel:

- `NODE_ENV=production`
- `PORT=5013`
- `REPL_ID=""` (vazio para desabilitar plugins do Replit)

### Comandos de Build
- **Build Command:** `npm run build`
- **Start Command:** `npm start`

### Context Path
Certifique-se de que o contexto do Docker aponta para a raiz do projeto onde estÃ¡ o `package.json`.

## ğŸ§ª Como Testar

### Teste Local com Docker
```bash
# Build da imagem
docker build -t meu-app .

# Executar container
docker run -p 5013:5013 meu-app

# Testar no navegador
curl http://localhost:5013/api/health
```

### VerificaÃ§Ã£o de Build
```bash
# Verificar se o build funciona
npm run build

# Verificar arquivos gerados
ls -la dist/

# Verificar se nÃ£o hÃ¡ imports do Vite no cÃ³digo final
grep -r "vite" dist/ || echo "âœ… Nenhuma referÃªncia ao Vite encontrada"
```

## ğŸ”§ Debugging

### Logs de Debug
Adicione no inÃ­cio do seu arquivo principal:

```javascript
console.log('ğŸ” Debug Info:');
console.log('NODE_ENV:', process.env.NODE_ENV);
console.log('PORT:', process.env.PORT);
console.log('Working Directory:', process.cwd());
console.log('Files in dist:', require('fs').readdirSync('./dist'));
```

### Checklist de VerificaÃ§Ã£o
- [ ] Vite estÃ¡ em `devDependencies`, nÃ£o em `dependencies`
- [ ] `npm run build` funciona localmente
- [ ] `dist/index.js` nÃ£o contÃ©m imports do Vite
- [ ] VariÃ¡veis de ambiente configuradas no EasyPanel
- [ ] Dockerfile usa multi-stage build corretamente
- [ ] Health check endpoint funciona

## ğŸ“‹ Passos de ImplementaÃ§Ã£o

### ImplementaÃ§Ã£o RÃ¡pida (SoluÃ§Ã£o 1)
1. **Substitua o Dockerfile** pelo corrigido
2. **Configure variÃ¡veis** no EasyPanel
3. **FaÃ§a commit** no GitHub
4. **Tente o deploy** novamente

### Se Ainda Houver Problemas (SoluÃ§Ã£o 3)
1. **Adicione o arquivo** `server-production.js`
2. **Modifique o Dockerfile** para usar este servidor
3. **Teste localmente** com Docker
4. **Deploy novamente**

### Para MÃ¡xima Compatibilidade (SoluÃ§Ã£o 4)
1. **Crie o script** `build.sh`
2. **Adicione o vite.config.production.ts**
3. **Atualize package.json**
4. **Teste todo o processo** localmente

## ğŸ¯ Por Que Essas SoluÃ§Ãµes Funcionam

### Problema Original
O seu Dockerfile original instalava apenas dependÃªncias de produÃ§Ã£o (`npm ci --only=production`), mas o Vite Ã© necessÃ¡rio durante o build e estava listado como devDependency.

### Como as SoluÃ§Ãµes Resolvem

1. **Dockerfile Corrigido:** Instala todas as dependÃªncias na etapa de build, depois remove devDependencies na produÃ§Ã£o
2. **Vite Config Simplificado:** Remove plugins problemÃ¡ticos que causam imports desnecessÃ¡rios
3. **Servidor Express Limpo:** Elimina completamente a dependÃªncia do Vite em produÃ§Ã£o
4. **Script de Build:** Garante que o processo de build seja consistente

### Compatibilidade com EasyPanel
- Usa Node.js Alpine para menor tamanho
- ExpÃµe porta corretamente
- Inclui health check
- Segue boas prÃ¡ticas de seguranÃ§a
- Funciona com GitHub integration

## ğŸš€ Resultado Esperado

ApÃ³s implementar essas soluÃ§Ãµes, vocÃª deve conseguir:
- âœ… Deploy bem-sucedido no EasyPanel
- âœ… AplicaÃ§Ã£o rodando na porta 5013
- âœ… Health check funcionando
- âœ… Frontend servido corretamente
- âœ… APIs funcionando normalmente

Se ainda houver problemas apÃ³s implementar a SoluÃ§Ã£o 1, passe para a SoluÃ§Ã£o 3 (servidor Express limpo) que Ã© praticamente Ã  prova de falhas.

